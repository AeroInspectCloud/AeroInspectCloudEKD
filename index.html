<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AERO INSPECT - Kundendaten</title>
    <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        #login-button, #fetch-data-button, #create-route-button {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 10px 20px;
            font-size: 14px;
            border: none;
            background-color: #0078d4;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            z-index: 10;
        }

        #fetch-data-button {
            margin-top: 50px;
        }

        #create-route-button {
            margin-top: 100px;
        }

        #data-table {
            position: absolute;
            top: 160px;
            left: 10px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 10;
        }

        #data-table th, #data-table td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }

        #data-table th {
            background-color: #0078d4;
            color: white;
        }

        .custom-marker {
            width: 20px;
            height: 20px;
            background-color: red;
            border-radius: 50%;
            cursor: pointer;
        }

        .custom-marker.selected {
            background-color: green;
        }
    </style>
</head>
<body>
    <button id="login-button">Login</button>
    <button id="fetch-data-button" disabled>Load Kundendaten</button>
    <button id="create-route-button" disabled>Create Route</button>
    <div id="map"></div>
    <table id="data-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Kundenname</th>
                <th>Langengrad</th>
                <th>Breitengrad</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        // Mapbox Access Token
        mapboxgl.accessToken = 'pk.eyJ1IjoiYWVyb2luc3BlY3QiLCJhIjoiY20zZDI5ZW1rMjV2dzJqc2U2cHZ0Y2I5ciJ9.ocXZqAz8Uyz0nkPD6ILZ5A';

        // MSAL-Konfiguration
        const msalConfig = {
            auth: {
                clientId: "73aa213c-f324-456a-bb09-dc0b6e9faac0", // App-ID
                authority: "https://login.microsoftonline.com/4a97cea8-8cc4-4d4c-8edc-3d59b870450f", // Azure Tenant
                redirectUri: "https://aeroinspectcloud.github.io" // Redirect-URI
            },
            cache: {
                cacheLocation: "localStorage",
                storeAuthStateInCookie: true
            },
            system: {
                allowRedirectInIframe: false
            }
        };

        const loginRequest = {
            scopes: ["https://microsoft.sharepoint.com/Sites.Read.All"]
        };

        const siteUrl = "https://aeroinspect.sharepoint.com/sites/AeroInspect"; // Deine SharePoint-URL
        const listEndpoint = `${siteUrl}/_api/web/lists(guid'ADA209A0-A9EB-4446-8371-B63FEC42FE8D')/items`;

        const msalInstance = new msal.PublicClientApplication(msalConfig);

        // Mapbox-Initialisierung
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v10',
            center: [10.0, 50.0],
            zoom: 5,
        });

        const directions = new MapboxDirections({
            accessToken: mapboxgl.accessToken,
            unit: 'metric',
            profile: 'mapbox/driving'
        });
        map.addControl(directions, 'top-left');

        let markers = []; // Zum Zurücksetzen der Marker
        let selectedMarkers = []; // Für ausgewählte Marker

        // Login-Button
        document.getElementById("login-button").addEventListener("click", async () => {
            try {
                const account = msalInstance.getAllAccounts()[0];
                if (!account) {
                    await msalInstance.loginPopup(loginRequest);
                }
                document.getElementById("fetch-data-button").disabled = false;
                alert("Erfolgreich angemeldet!");
            } catch (error) {
                console.error("Login-Fehler:", error);
                alert("Login fehlgeschlagen. Bitte versuchen Sie es erneut.");
            }
        });

        // Kundendaten abrufen
        document.getElementById("fetch-data-button").addEventListener("click", async () => {
            try {
                const account = msalInstance.getAllAccounts()[0];
                let token;

                try {
                    const tokenResponse = await msalInstance.acquireTokenSilent({
                        ...loginRequest,
                        account
                    });
                    token = tokenResponse.accessToken;
                } catch (error) {
                    if (error instanceof msal.InteractionRequiredAuthError) {
                        const tokenResponse = await msalInstance.acquireTokenPopup({
                            ...loginRequest
                        });
                        token = tokenResponse.accessToken;
                    } else {
                        throw error;
                    }
                }

                const response = await fetch(listEndpoint, {
                    headers: {
                        Authorization: `Bearer ${token}`,
                        Accept: "application/json;odata=verbose"
                    }
                });

                if (!response.ok) {
                    throw new Error(`Fehler beim Abrufen der Daten: ${response.statusText}`);
                }

                const data = await response.json();
                const customerData = data.d?.results || [];
                updateMarkers(customerData);
                populateTable(customerData);
                document.getElementById("create-route-button").disabled = false;
            } catch (error) {
                console.error("Fehler beim Abrufen der Daten:", error);
                alert("Fehler beim Abrufen der Daten. Bitte versuchen Sie es erneut.");
            }
        });

        // Marker auf Karte anzeigen
        function updateMarkers(customers) {
            markers.forEach(marker => marker.remove());
            markers = [];
            selectedMarkers = [];

            customers.forEach(customer => {
                const lng = parseFloat(customer.L_x00e4_ngengrad?.replace(',', '.'));
                const lat = parseFloat(customer.Breitengrad?.replace(',', '.'));

                if (isNaN(lng) || isNaN(lat)) {
                    console.warn(`Ungültige Koordinaten für ${customer.Kundenname || "Unbekannt"}`);
                    return;
                }

                const markerElement = document.createElement('div');
                markerElement.className = 'custom-marker';

                const marker = new mapboxgl.Marker({ element: markerElement })
                    .setLngLat([lng, lat])
                    .addTo(map);

                markerElement.addEventListener('click', () => {
                    if (markerElement.classList.contains('selected')) {
                        markerElement.classList.remove('selected');
                        selectedMarkers = selectedMarkers.filter(m => m.lng !== lng || m.lat !== lat);
                    } else {
                        markerElement.classList.add('selected');
                        selectedMarkers.push({ lng, lat });
                    }
                });

                markers.push(marker);
            });
        }

        // Route erstellen
        document.getElementById("create-route-button").addEventListener("click", () => {
            if (selectedMarkers.length < 2) {
                alert("Bitte wählen Sie mindestens zwei Marker aus, um eine Route zu erstellen.");
                return;
            }

            directions.setOrigin([selectedMarkers[0].lng, selectedMarkers[0].lat]);
            directions.setDestination([selectedMarkers[selectedMarkers.length - 1].lng, selectedMarkers[selectedMarkers.length - 1].lat]);

            for (let i = 1; i < selectedMarkers.length - 1; i++) {
                directions.addWaypoint(i - 1, [selectedMarkers[i].lng, selectedMarkers[i].lat]);
            }
        });

        // Tabelle füllen
        function populateTable(customers) {
            const table = document.getElementById("data-table");
            const tbody = table.querySelector("tbody");
            tbody.innerHTML = "";

            customers.forEach(customer => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${customer.Id}</td>
                    <td>${customer.Kundenname || "-"}</td>
                    <td>${customer.L_x00e4_ngengrad || "-"}</td>
                    <td>${customer.Breitengrad || "-"}</td>
                `;
                tbody.appendChild(row);
            });

            table.style.display = "block";
        }
    </script>
</body>
</html>
