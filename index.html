<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AERO INSPECT - MAP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Mapbox CSS und JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <!-- PapaParse Library for CSV Parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .custom-marker {
            width: 20px;
            height: 20px;
            background-color: black;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        // Mapbox Access Token
        mapboxgl.accessToken = 'pk.eyJ1IjoiYWVyb2luc3BlY3QiLCJhIjoiY20zZDI5ZW1rMjV2dzJqc2U2cHZ0Y2I5ciJ9.ocXZqAz8Uyz0nkPD6ILZ5A';

        // Initialisiere die Map
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [10.0, 50.0],
            zoom: 5,
        });

        // URL der SharePoint CSV-Datei
        const csvUrl = 'https://aeroinspect.sharepoint.com/:l:/s/AeroInspect/FKAJoq3rqUZEg3G2P-xC_o0BcQkCJRYXZfnejgzlEGPDaA?download=1';

        // Funktion zum Abrufen und Verarbeiten der CSV-Daten
        async function fetchCSVData() {
            try {
                const response = await fetch(csvUrl);
                const csvText = await response.text();

                // CSV-Daten mit PapaParse verarbeiten
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        const data = results.data;
                        const bounds = new mapboxgl.LngLatBounds();

                        data.forEach((row) => {
                            const name = row.Name || 'Unbekannt';
                            const latitude = parseFloat(row.Latitude);
                            const longitude = parseFloat(row.Longitude);

                            if (!isNaN(latitude) && !isNaN(longitude)) {
                                // Marker erstellen
                                const markerElement = document.createElement('div');
                                markerElement.className = 'custom-marker';

                                const popup = new mapboxgl.Popup().setText(`${name}`);

                                new mapboxgl.Marker({ element: markerElement })
                                    .setLngLat([longitude, latitude])
                                    .setPopup(popup)
                                    .addTo(map);

                                bounds.extend([longitude, latitude]);
                            }
                        });

                        // Karte auf die Marker zentrieren
                        map.fitBounds(bounds, { padding: 50 });
                    },
                });
            } catch (error) {
                console.error('Fehler beim Abrufen der CSV-Daten:', error);
            }
        }

        // CSV-Daten beim Laden der Karte abrufen
        map.on('load', fetchCSVData);

        // Daten alle 60 Sekunden aktualisieren
        setInterval(fetchCSVData, 60000);
    </script>
</body>
</html>
