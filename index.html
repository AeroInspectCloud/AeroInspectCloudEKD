<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AERO INSPECT - Kundendaten</title>
    <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <style>
        /* Allgemeiner Stil */
        body {
            margin: 0;
            font-family: 'Arial', sans-serif;
            background-color: #121212;
            color: #f0f0f0;
        }

        /* Karte */
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        /* Buttons */
        #login-button, #fetch-data-button, #data-button {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 10px 20px;
            font-size: 14px;
            border: none;
            background-color: #1f1f1f;
            color: #f0f0f0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        #fetch-data-button {
            margin-top: 60px;
        }

        #data-button {
            margin-top: 120px;
        }

        #login-button:hover, #fetch-data-button:hover, #data-button:hover {
            background-color: #333;
            color: #fff;
        }

        /* Popup-Tabelle */
        #data-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #1f1f1f;
            border: 1px solid #333;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.7);
            width: 80%;
            max-width: 600px;
            max-height: 70%;
            overflow-y: auto;
            padding: 20px;
            display: none;
            z-index: 20;
        }

        #data-popup table {
            width: 100%;
            border-collapse: collapse;
        }

        #data-popup th, #data-popup td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        #data-popup th {
            background-color: #333;
            color: #f0f0f0;
        }

        #close-popup {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #f0f0f0;
            font-size: 18px;
            cursor: pointer;
        }

        #close-popup:hover {
            color: #ff5555;
        }

        /* Marker */
        .custom-marker {
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            border: 2px solid black;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <button id="login-button">Login</button>
    <button id="fetch-data-button" disabled>Load Kundendaten</button>
    <button id="data-button">Show Data</button>
    <div id="map"></div>

    <!-- Popup f체r die Tabelle -->
    <div id="data-popup">
        <button id="close-popup">&times;</button>
        <table id="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Vorname</th>
                    <th>Nachname</th>
                    <th>L채ngengrad</th>
                    <th>Breitengrad</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        // Mapbox Access Token
        mapboxgl.accessToken = 'pk.eyJ1IjoiYWVyb2luc3BlY3QiLCJhIjoiY20zZDI5ZW1rMjV2dzJqc2U2cHZ0Y2I5ciJ9.ocXZqAz8Uyz0nkPD6ILZ5A';

        // MSAL Konfiguration
        const msalConfig = {
            auth: {
                clientId: "73aa213c-f324-456a-bb09-dc0b6e9faac0",
                authority: "https://login.microsoftonline.com/4a97cea8-8cc4-4d4c-8edc-3d59b870450f",
                redirectUri: window.location.origin,
            },
            cache: {
                cacheLocation: "localStorage",
                storeAuthStateInCookie: false,
            }
        };

        const loginRequest = { scopes: ["User.Read"] };
        const siteUrl = "https://example.sharepoint.com";
        const listEndpoint = `${siteUrl}/_api/web/lists(guid'ADA209A0-A9EB-4446-8371-B63FEC42FE8D')/items`;

        const msalInstance = new msal.PublicClientApplication(msalConfig);

        // Mapbox-Initialisierung
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v10',
            center: [10.0, 50.0],
            zoom: 5,
        });

        // Login-Button
        document.getElementById("login-button").addEventListener("click", async () => {
            try {
                const account = msalInstance.getAllAccounts()[0];
                if (!account) await msalInstance.loginPopup(loginRequest);
                document.getElementById("fetch-data-button").disabled = false;
                alert("Erfolgreich angemeldet!");
            } catch (error) {
                console.error("Login-Fehler:", error);
                alert("Login fehlgeschlagen. Bitte versuchen Sie es erneut.");
            }
        });

        // Kundendaten abrufen
        document.getElementById("fetch-data-button").addEventListener("click", async () => {
            try {
                const account = msalInstance.getAllAccounts()[0];
                const tokenResponse = await msalInstance.acquireTokenSilent({
                    ...loginRequest,
                    account,
                });

                const response = await fetch(listEndpoint, {
                    headers: {
                        Authorization: `Bearer ${tokenResponse.accessToken}`,
                        Accept: "application/json;odata=verbose",
                    },
                });

                if (!response.ok) throw new Error(`Fehler beim Abrufen der Daten: ${response.statusText}`);

                const data = await response.json();
                const customerData = data.d.results;
                console.log("API-Daten:", customerData);

                displayMarkers(customerData);
                populateTable(customerData);
            } catch (error) {
                console.error("Fehler beim Abrufen der Daten:", error);
                alert("Fehler beim Abrufen der Daten. Bitte versuchen Sie es erneut.");
            }
        });

        // Marker und Popups erstellen
        function displayMarkers(customers) {
            customers.forEach(customer => {
                const lng = parseFloat(customer.L_x00e4_ngengrad?.replace(',', '.').trim());
                const lat = parseFloat(customer.Breitengrad?.replace(',', '.').trim());

                if (isNaN(lng) || isNaN(lat) || lng < -180 || lng > 180 || lat < -90 || lat > 90) return;

                const markerElement = document.createElement('div');
                markerElement.className = 'custom-marker';

                const popup = new mapboxgl.Popup({ offset: 25 }).setHTML(`
                    <h3>${customer.Vorname || "Unbekannt"} ${customer.Nachname || ""}</h3>
                    <p>ID: ${customer.Id}</p>
                `);

                new mapboxgl.Marker(markerElement)
                    .setLngLat([lng, lat])
                    .setPopup(popup)
                    .addTo(map);
            });
        }

        // Daten in die Tabelle einf체gen
        function populateTable(customers) {
            const tbody = document.querySelector("#data-table tbody");
            tbody.innerHTML = "";

            customers.forEach(customer => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${customer.Id}</td>
                    <td>${customer.Vorname || "-"}</td>
                    <td>${customer.Nachname || "-"}</td>
                    <td>${customer.L_x00e4_ngengrad || "-"}</td>
                    <td>${customer.Breitengrad || "-"}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Popup f체r die Tabelle anzeigen/verstecken
        document.getElementById("data-button").addEventListener("click", () => {
            document.getElementById("data-popup").style.display = "block";
        });

        document.getElementById("close-popup").addEventListener("click", () => {
            document.getElementById("data-popup").style.display = "none";
        });
    </script>
</body>
</html>
